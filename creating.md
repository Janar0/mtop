# Как я писал mtop: пошаговый процесс разработки

## Идея и концепция

Проект **mtop** начался с идеи создания простого инструмента для мониторинга использования системных ресурсов (CPU, RAM, GPU) под Linux. Основная цель заключалась в упрощении работы системных администраторов и разработчиков, нуждающихся в оперативной информации о состоянии системы, без необходимости в сложных внешних инструментах. Я решил сосредоточиться на Linux, так как многие утилиты, используемые в проекте, лучше поддерживаются в этой операционной системе.

---

## Шаги разработки

### 1. Выбор технологий

- **Python**: выбран из-за простоты, гибкости и наличия множества библиотек.
- **psutil**: для получения данных о CPU и памяти. Это надёжная библиотека для работы с системными ресурсами.
- **shutil и subprocess**: для взаимодействия с утилитами `nvidia-smi` и `rocm-smi` для GPU. Эти команды позволяют собрать данные о графических процессорах на системах NVIDIA и AMD.
- **blessed**: для создания удобного текстового интерфейса с поддержкой адаптации под размеры терминала.

### 2. Написание базового функционала

#### Сбор данных о CPU
Я начал с использования функции `psutil.cpu_percent(interval=0.5)` для получения процентной загрузки процессора. Первоначально интервал обновления выбрал 0.5 секунд, чтобы данные были точными и не включали прошлые значения.

#### Сбор данных о RAM
Для определения использования оперативной памяти использовал `psutil.virtual_memory().percent`, возвращающую процент текущего использования. Это позволило быстро добавить метрику в программу.

#### Добавление поддержки GPU
1. Проверка наличия утилит `nvidia-smi` и `rocm-smi` через `shutil.which`. Этот шаг позволяет определить, установлены ли драйверы и соответствующее ПО для GPU.
2. Обработка вывода:
   - Для `nvidia-smi` использовал `subprocess.check_output` с параметром `--query-gpu=utilization.gpu` для получения текущего процента использования GPU.
   - Для `rocm-smi` проанализировал строки с `GPU use:` и извлёк числовые значения, убрав лишние символы.

### 3. Визуализация данных

#### Функция `draw_bar`
Я написал функцию для построения текстовой полосы загрузки:
```python
def draw_bar(value, width=30, char='█'):
    filled = int(value * width / 100)
    bar_str = char * filled + ' ' * (width - filled)
    return bar_str
```
Эта функция отображает графическую шкалу, пропорциональную проценту загрузки, и используется для CPU, RAM и GPU.

#### Графический и текстовый режимы
- В текстовом режиме данные выводятся в числовом формате.
- В графическом режиме я добавил визуальные полосы загрузки, используя функцию `draw_bar` и учитывая ширину терминала через `blessed.Terminal`.

### 4. Аргументы командной строки

Использовал `argparse` для добавления следующих аргументов:
- `-g/--graph`: отображение данных в виде графиков.
- `-r/--run`: непрерывный режим обновления.
- `-i/--interval`: задаёт интервал обновления (в секундах).

Примеры использования программы:
```bash
mtop             # Один вывод без графики
mtop -g          # Один вывод с графикой
mtop -r          # Непрерывный режим без графики
mtop -r -g       # Непрерывный режим с графикой
```

### 5. Непрерывный режим работы

Для реализации непрерывного вывода данных использовал цикл `while` с интервалами обновления из `args.interval`. Использовал `blessed.Terminal` для:
- Скрытия курсора и очистки экрана между обновлениями.
- Адаптации ширины отображения данных под размеры терминала.

Добавил обработку исключения `KeyboardInterrupt`, чтобы корректно завершать работу программы при нажатии Ctrl+C.

### 6. Полировка

- Убедился, что программа возвращает `N/A` для GPU, если `nvidia-smi` или `rocm-smi` отсутствуют.
- Добавил эпилог с примерами использования в `argparse` для повышения удобства пользователей.
- Тестировал приложение на различных дистрибутивах Linux, чтобы убедиться в его работоспособности.

---

## Проблемы, с которыми столкнулся

1. **Получение данных о GPU**:
   - Разные утилиты и форматы вывода для NVIDIA и AMD.
   - Необходимость обработки ошибок для отсутствующих GPU или драйверов.

2. **Совместимость с терминалами**:
   - Ограничения ширины терминала в графическом режиме.
   - Необходимость адаптировать отображение для малых экранов.

3. **Точность данных**:
   - Замеры CPU требуют начальной задержки для корректных показаний.

---

## Результат

Программа **mtop** стала мощным, но простым инструментом для мониторинга системы в Linux. Она поддерживает как текстовый, так и графический режимы, обеспечивает удобство использования и гибкость настройки. Поддержка GPU и адаптивный интерфейс делают её полезной для системных администраторов и разработчиков.

